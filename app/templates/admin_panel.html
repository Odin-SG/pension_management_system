<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/styles.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
</head>
<body>
    <header>
        Панель Администратора - Управление Пенсионными Накоплениями
    </header>
    <main>
        <section class="container">
            <h1>Список пользователей</h1>
            <table class="user-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Логин</th>
                        <th>Общая сумма накоплений (руб.)</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                        <tr>
                            <td>{{ user.id }}</td>
                            <td>{{ user.username }}</td>
                            <td>{{ user.total_amount }}</td>
                            <td>
                                <button class="view-user-button" data-user-id="{{ user.id }}">Посмотреть</button>
                                <button class="edit-user-button" data-user-id="{{ user.id }}">Редактировать</button>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </section>

        <section id="user-details" class="container" style="display: none;">
            <h2>Информация о пользователе</h2>
            <p>Логин: <strong id="user-username"></strong></p>
            <p>Роль: <strong id="user-role"></strong></p>
            <p>Общая сумма накоплений: <strong id="user-total-amount"></strong> руб.</p>
            <h3>История вкладов:</h3>
            <ul id="user-history"></ul>
        </section>

        <div id="edit-user-modal" class="modal">
            <div class="modal-content">
                <span class="close-button">&times;</span>
                <h2>Редактирование пользователя</h2>
                <form id="edit-user-form" method="post">
                    <input type="hidden" id="edit-user-id" name="user_id">
                    <label for="new-username">Новый логин:</label>
                    <input type="text" id="new-username" name="new_username">
                    <label for="new-role">Новая роль:</label>
                    <select id="new-role" name="new_role">
                        <option value="user">Пользователь</option>
                        <option value="admin">Администратор</option>
                    </select>
                    <label for="new-amount">Добавить сумму накоплений (руб.):</label>
                    <input type="number" id="new-amount" name="new_amount" step="0.01">
                    <button type="submit" class="button">Сохранить изменения</button>
                </form>
            </div>
        </div>
    </main>

    <footer>
        &copy; 2024 Управление Пенсионными Накоплениями
    </footer>

    <script>
        $(document).ready(function() {
            // Открытие модального окна для редактирования
            var editModal = $('#edit-user-modal');
            var closeButton = $('.close-button');

            $('.edit-user-button').on('click', function() {
                var userId = $(this).data('user-id');
                $('#edit-user-id').val(userId);
                editModal.show();
            });

            closeButton.on('click', function() {
                editModal.hide();
            });

            $(window).on('click', function(event) {
                if ($(event.target).is(editModal)) {
                    editModal.hide();
                }
            });

            // Получение информации о конкретном пользователе
            $('.view-user-button').on('click', function() {
                var userId = $(this).data('user-id');
                $.get("/admin_panel", { user_id: userId }, function(data) {
                    if (data.specific_user) {
                        $('#user-details').show();
                        $('#user-username').text(data.specific_user.username);
                        $('#user-role').text(data.specific_user.role);
                        $('#user-total-amount').text(data.specific_user.total_amount);

                        var historyHtml = '';
                        data.user_history.forEach(function(entry) {
                            historyHtml += '<li>Сумма: ' + entry.amount + ' руб., Дата: ' + entry.contribution_date + '</li>';
                        });
                        $('#user-history').html(historyHtml);
                    }
                });
            });
        });
    </script>
</body>
</html>
